---
import SectionHead from '../SectionHead.astro';
import { getCollection } from 'astro:content';
import type { Lang, ProjectsContent, LinksContent } from '@content/content.type';

const locale = Astro.currentLocale ?? 'zh';
const lang: Lang = locale === 'en' ? 'en' : 'zh';

const entries = await getCollection('projects');
const defaultEntry = entries.find((entry) => entry.data.locale === 'zh');
const currentEntry = entries.find((entry) => entry.data.locale === lang) ?? defaultEntry;

if (!currentEntry) {
  throw new Error('Missing projects content entry.');
}

const linkEntries = await getCollection('links');
const linkEntry = linkEntries[0];
if (!linkEntry) {
  throw new Error('Missing links content entry.');
}
const projectLinks = (linkEntry.data as LinksContent).links.projects;

const getProjectLinks = (projectTitle: string) => {
  return projectLinks.find((link) => projectTitle.includes(link.id));
};

const { title, desc, items } = currentEntry.data as ProjectsContent;
---

<section
  id="projects"
  class="mt-9 border rounded-2xl p-6 shadow-[var(--shadow)]"
  style={{ background: 'rgba(255,255,255,0.02)', borderColor: 'var(--border)' }}
>
  <SectionHead title={title} desc={desc} />
  <div class="grid gap-3" style={{ gridTemplateColumns: 'repeat(auto-fit, minmax(260px, 1fr))' }}>
    {
      items.map((item) => (
        <article
          class="border rounded-xl p-4"
          style={{ borderColor: 'var(--border)', background: 'rgba(255,255,255,0.02)' }}
        >
          <div class="flex justify-between gap-3 items-center flex-wrap">
            <div>
              <p class="text-[13px] text-[var(--muted)] m-0 mb-1">{item.time}</p>
              <h3 class="m-0">{item.title}</h3>
            </div>
            <span
              class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-sm font-semibold border"
              style={{
                background: 'rgba(77, 212, 182, 0.12)',
                color: 'var(--accent-strong)',
                borderColor: 'rgba(77, 212, 182, 0.24)',
              }}
            >
              {item.chip}
            </span>
          </div>
          <p class="mt-2 mb-0 text-[var(--muted)]">{item.desc}</p>
          {(() => {
            const links = getProjectLinks(item.title);
            if (!links) return null;
            return (
              <div class="flex gap-3 mt-3">
                {links.urls.web && (
                  <a
                    href={links.urls.web}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="inline-flex items-center gap-1 text-sm text-[var(--accent)] hover:text-[var(--accent-strong)] transition-colors"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <circle cx="12" cy="12" r="10" />
                      <line x1="2" y1="12" x2="22" y2="12" />
                      <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" />
                    </svg>
                    <span>Chrome Web Store</span>
                  </a>
                )}
                <a
                  href={links.urls.repo}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center gap-1 text-sm text-[var(--accent)] hover:text-[var(--accent-strong)] transition-colors"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" />
                  </svg>
                  <span>Repo</span>
                </a>
              </div>
            );
          })()}
        </article>
      ))
    }
  </div>
</section>
