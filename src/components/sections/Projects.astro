---
import SectionHead from '../SectionHead.astro';
import ProjectLinks from '../ProjectLinks.astro';
import { getCollection } from 'astro:content';
import type { Lang, ProjectsContent, LinksContent } from '@content/content.type';

const locale = Astro.currentLocale ?? 'zh';
const lang: Lang = locale === 'en' ? 'en' : 'zh';

const entries = await getCollection('projects');
const defaultEntry = entries.find((entry) => entry.data.locale === 'zh');
const currentEntry = entries.find((entry) => entry.data.locale === lang) ?? defaultEntry;

if (!currentEntry) {
  throw new Error('Missing projects content entry.');
}

const linkEntries = await getCollection('links');
const linkEntry = linkEntries[0];
if (!linkEntry) {
  throw new Error('Missing links content entry.');
}
const projectLinks = (linkEntry.data as LinksContent).links.projects;

const getProjectLinks = (projectTitle: string) => {
  return projectLinks.find((link) => projectTitle.includes(link.id));
};

const { title, desc, items } = currentEntry.data as ProjectsContent;
---

<section
  id="projects"
  class="mt-9 border rounded-2xl p-6 shadow-[var(--shadow)]"
  style={{ background: 'rgba(255,255,255,0.02)', borderColor: 'var(--border)' }}
>
  <SectionHead title={title} desc={desc} />
  <div class="grid gap-3" style={{ gridTemplateColumns: 'repeat(auto-fit, minmax(260px, 1fr))' }}>
    {
      items.map((item) => (
        <article
          class="border rounded-xl p-4"
          style={{ borderColor: 'var(--border)', background: 'rgba(255,255,255,0.02)' }}
        >
          <div class="flex justify-between gap-3 items-center flex-wrap">
            <div>
              <p class="text-[13px] text-[var(--muted)] m-0 mb-1">{item.time}</p>
              <h3 class="m-0">{item.title}</h3>
            </div>
            <span
              class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-sm font-semibold border"
              style={{
                background: 'rgba(77, 212, 182, 0.12)',
                color: 'var(--accent-strong)',
                borderColor: 'rgba(77, 212, 182, 0.24)',
              }}
            >
              {item.chip}
            </span>
          </div>
          <p class="mt-2 mb-0 text-[var(--muted)]">{item.desc}</p>
          {(() => {
            const links = getProjectLinks(item.title);
            if (!links) return null;
            return (
              <ProjectLinks
                web={links.urls.web}
                webLabel={links.urls.webLabel}
                repo={links.urls.repo}
              />
            );
          })()}
        </article>
      ))
    }
  </div>
</section>
