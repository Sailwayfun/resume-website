---
import BaseLayout from '@layouts/BaseLayout.astro';
import HeaderBar from '@components/HeaderBar.astro';
import Hero from '@components/sections/Hero.astro';
import Skills from '@components/sections/Skills.astro';
import Experience from '@components/sections/Experience.astro';
import Projects from '@components/sections/Projects.astro';
import Education from '@components/sections/Education.astro';
import IconBadge from '@components/IconBadge.astro';
import ContactLines from '@components/ContactLines.astro';

import { getCollection } from 'astro:content';
import type {
  BaseContent,
  EducationContent,
  ExperienceContent,
  Lang,
  LinksContent,
  ProjectsContent,
  SkillsContent,
} from '@data/content.type';

type LocaleCollectionName = 'base' | 'skills' | 'experience' | 'projects' | 'education';

type LocaleCollectionMap = {
  base: BaseContent;
  skills: SkillsContent;
  experience: ExperienceContent;
  projects: ProjectsContent;
  education: EducationContent;
};

const locale = Astro.currentLocale ?? 'zh';
const lang: Lang = locale === 'en' ? 'en' : 'zh';

const getLocaleEntry = async <T extends LocaleCollectionName>(
  collection: T,
  localeValue: Lang
): Promise<LocaleCollectionMap[T]> => {
  const entries = await getCollection(collection);
  const defaultEntry = entries.find((entry) => entry.data.locale === 'zh');
  const currentEntry = entries.find((entry) => entry.data.locale === localeValue) ?? defaultEntry;

  if (!currentEntry) {
    throw new Error(`Missing ${collection} content entry.`);
  }

  return currentEntry.data as LocaleCollectionMap[T];
};

const base = await getLocaleEntry('base', lang);
const skills = await getLocaleEntry('skills', lang);
const experience = await getLocaleEntry('experience', lang);
const projects = await getLocaleEntry('projects', lang);
const education = await getLocaleEntry('education', lang);

const linkEntries = await getCollection('links');
const linkEntry = linkEntries[0];
if (!linkEntry) {
  throw new Error('Missing links content entry.');
}
const links = (linkEntry.data as LinksContent).links;

const { meta, hero, nav, footer } = base;
const { title, description, ogUrl, ogImageUrl } = meta;
---

<BaseLayout
  lang={lang}
  title={title}
  description={description}
  ogUrl={ogUrl}
  ogImageUrl={ogImageUrl}
>
  <div
    class="fixed inset-0 bg-gradient-to-br from-[rgba(77,212,182,0.08)] to-[rgba(55,107,255,0.05)] blur-[40px] opacity-90 pointer-events-none z-0 print-hidden"
  >
  </div>
  <div class="relative z-10 max-w-[1080px] mx-auto px-7 pb-16 pt-12">
    <HeaderBar lang={lang} nav={nav} links={links} />

    <Hero
      eyebrowHtml={hero.eyebrowHtml}
      nameHtml={hero.nameHtml}
      ledeHtml={hero.ledeHtml}
      locationLabel={hero.locationLabel}
      locationValue={hero.locationValue}
      contactLabel={hero.contactLabel}
      contactEmail={hero.contactEmail}
      titleLabel={hero.titleLabel}
      titleValue={hero.titleValue}
      langLabel={hero.langLabel}
      langValue={hero.langValue}
      ctaLabel={hero.ctaLabel}
    />

    <Skills title={skills.title} desc={skills.desc} items={skills.items} />
    <Experience title={experience.title} desc={experience.desc} items={experience.items} />
    <Projects title={projects.title} desc={projects.desc} items={projects.items} />
    <Education title={education.title} desc={education.desc} items={education.items} />

    <footer
      class="mt-8 border rounded-xl p-5 flex flex-wrap gap-3 items-center shadow-[var(--shadow)]"
      style={{
        background: 'rgba(255,255,255,0.02)',
        borderColor: 'var(--border)',
        color: 'var(--muted)',
      }}
    >
      <div
        class="flex items-center gap-3 px-3 py-3 rounded-xl"
        style={{
          border: '1px solid rgba(255,255,255,0.08)',
          background: 'rgba(255,255,255,0.02)',
        }}
      >
        <IconBadge>
          <svg class="w-[18px] h-[18px] fill-[var(--accent-strong)]" viewBox="0 0 24 24">
            <path
              d="M4.5 6.2 10 10c1.2.8 2.8.8 4 0l5.5-3.8c.3-.2.5-.5.5-.9 0-.7-.6-1.3-1.3-1.3H5.3C4.6 4 4 4.6 4 5.3c0 .3.2.7.5.9ZM20 8.3l-4.7 3.3a4.8 4.8 0 0 1-5.6 0L5 8.3V16c0 1 .8 1.8 1.8 1.8h11.4c1 0 1.8-.8 1.8-1.8V8.3Z"
            ></path>
          </svg>
        </IconBadge>
        <div>
          <p class="text-[13px] text-[var(--muted)] m-0 mb-1">{footer.contactLabel}</p>
          <ContactLines />
        </div>
      </div>
      <div
        class="flex items-center gap-3 px-3 py-3 rounded-xl"
        style={{
          border: '1px solid rgba(255,255,255,0.08)',
          background: 'rgba(255,255,255,0.02)',
        }}
      >
        <IconBadge>
          <svg class="w-[18px] h-[18px] fill-[var(--accent-strong)]" viewBox="0 0 24 24">
            <path
              d="M12 2.5c-3.5 0-6.5 2.8-6.5 6.4 0 4.9 6.5 12.6 6.5 12.6s6.5-7.7 6.5-12.6c0-3.6-3-6.4-6.5-6.4Zm0 9.2a2.8 2.8 0 1 1 0-5.6 2.8 2.8 0 0 1 0 5.6Z"
            ></path>
          </svg>
        </IconBadge>
        <div>
          <p class="text-[13px] text-[var(--muted)] m-0 mb-1">{footer.roleLabel}</p>
          <p class="m-0 font-semibold leading-6 text-[var(--text)]">
            {footer.roleValue}
          </p>
        </div>
      </div>
      <p class="m-0 ml-auto text-[var(--muted)]">{footer.updateText}</p>
    </footer>
  </div>
</BaseLayout>
